{% extends 'base.html' %}
{% block content %}

<div class="tour-detail-wrapper">

  <!-- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
  <div class="tour-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <div style="font-size: 20px; font-weight: 600;">{{ tour.city }} ‚Äî {{ tour.country }}</div>
    <div style="background: #f1f1f1; padding: 6px 10px; border-radius: 6px; font-size: 14px; color: #555; margin-left: auto;">
      <p><strong>–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</strong> {{ tour.departure_date }}</p>
    </div>
    <div class="tour-date-selector" onclick="toggleDateForm()" style="width: 100%; margin-top: 8px;">
      {{ tour.tourists or 1 }} —Ç—É—Ä–∏—Å—Ç(–∞), {{ tour.nights }} –Ω–æ—á–µ–π
    </div>
    <div id="dateForm" class="date-form hidden">
      <label>–¢—É—Ä–∏—Å—Ç–æ–≤:</label>
      <input type="number" id="tourists" min="1" value="{{ tour.tourists or 1 }}" />
      <label>–ù–æ—á–µ–π:</label>
      <select id="nights-select">
        {% for n in range(2, 21) %}
          <option value="{{ n }}" {% if n == tour.nights %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
      <button type="button" onclick="applyDates()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
  
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />

  <!-- –ì–∞–ª–µ—Ä–µ—è -->
  {% if tour.gallery %}
  <div style="margin-bottom: 15px;">
    <div class="swiper main-swiper" style="width: 100%; height: 200px; border-radius: 12px; overflow: hidden;">
      <div class="swiper-wrapper">
        {% for img in tour.gallery %}
        <div class="swiper-slide">
          {% if img.startswith('http') %}
            <a href="{{ img }}" class="glightbox" data-gallery="tour-gallery">
              <img src="{{ img }}" style="width: 100%; height: 250px; object-fit: contain;">
            </a>
          {% else %}
            <a href="{{ url_for('static', filename='img/' + img) }}" class="glightbox" data-gallery="tour-gallery">
              <img src="{{ url_for('static', filename='img/' + img) }}" style="width: 100%; height: 500px; object-fit: cover;">
            </a>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>
  </div>

  <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã -->
  <div class="swiper thumb-swiper">
    <div class="swiper-wrapper">
      {% for img in tour.gallery %}
      <div class="swiper-slide">
        {% if img.startswith('http') %}
          <img src="{{ img }}">
        {% else %}
          <img src="{{ url_for('static', filename='img/' + img) }}">
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- –ò–Ω—Ñ–æ -->
  <div class="tour-info-card">
    <h2>{{ tour.hotel }}</h2>
    <p><strong>–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</strong> {{ tour.departure_date }}</p>
    <p>{{ tour.description }}</p>
    <div style="margin-top: 20px;">
      <a href="{{ url_for('filter_page') }}" class="back-link">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ç—É—Ä–∞
      </a>
    </div>
  </div>

</div>

<!-- –§–æ—Ä–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
<form action="{{ url_for('confirmation_page', tour_id=tour_id) }}" method="get" id="bookForm">
  <input type="hidden" name="departure_date" value="{{ tour.departure_date }}">
  <input type="hidden" name="tourists" id="formTourists" value="1">
  <input type="hidden" name="nights" id="formNights" value="{{ tour.nights }}">
  <input type="hidden" name="total_price" id="formPrice" value="{{ tour.price }}">
  <div class="tour-fixed-buttons">
    <button type="submit" id="bookButton" class="btn-book">
      –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä –∑–∞ {{ tour.price | default(0) }} ‚Ç∏
    </button>
  </div>
</form>

<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

<script>
function toggleDateForm() {
  const el = document.getElementById("dateForm");
  el.classList.toggle("hidden");
}

function applyDates() {
  const people = parseInt(document.getElementById("tourists").value) || 1;
  const nights = parseInt(document.getElementById("nights-select").value) || 1;
  const basePrice = {{ tour.price }};
  const baseNights = {{ tour.nights }};
  const pricePerNight = basePrice / baseNights;
  const total = Math.round(pricePerNight * people * nights);

  document.getElementById("formTourists").value = people;
  document.getElementById("formNights").value = nights;
  document.getElementById("formPrice").value = total;
  document.getElementById("bookButton").innerText = `–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä –∑–∞ ${total.toLocaleString()} ‚Ç∏`;
  document.querySelector(".tour-date-selector").innerText = `${people} —Ç—É—Ä–∏—Å—Ç(–∞), ${nights} –Ω–æ—á–µ–π`;

  document.getElementById("dateForm").classList.add("hidden");
}
</script>

<style>
  .tour-detail-wrapper { max-width: 1000px; margin: 0 auto 80px; padding: 20px; font-family: 'Segoe UI', sans-serif; }
  .tour-date-selector { font-size: 16px; color: #3498db; cursor: pointer; margin-bottom: 10px; }
  .date-form { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
  .date-form input, .date-form select { display: block; margin-bottom: 10px; padding: 6px; width: 100%; }
  .tour-slider { border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
  .tour-image-slide { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; }
  .tour-info-card { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 0 8px rgba(0,0,0,0.05); font-size: 15px; color: #333; }
  .tour-info-card h2 { margin-bottom: 6px; font-size: 20px; }
  .tour-fixed-buttons { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: #fff; padding: 12px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.08); z-index: 999; }
  .btn-book { background: #2ecc71; color: white; font-size: 15px; font-weight: 600; padding: 12px; border: none; border-radius: 10px; width: 100%; cursor: pointer; }
  .hidden { display: none; }
  .back-link { text-decoration: none; display: inline-block; background: #eee; color: #333; padding: 8px 14px; border-radius: 8px; font-weight: 500; }
  .thumb-swiper {background: #fff; padding: 10px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .thumb-swiper .swiper-slide {height: 60px; cursor: pointer; }
  .thumb-swiper .swiper-slide img {width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: transform 0.2s ease; }
  .thumb-swiper .swiper-slide img:hover {transform: scale(1.05); }
</style>

<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
<script>
  const thumbSwiper = new Swiper('.thumb-swiper', {
      spaceBetween: 8,
      slidesPerView: 5,
      watchSlidesProgress: true,
      breakpoints: {
          768: { slidesPerView: 8 }
      }
  });
    // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ª–∞–π–¥–µ—Ä
const mainSwiper = new Swiper('.main-swiper', {
    slidesPerView: 3,
    slidesPerGroup: 3,
    spaceBetween: 10,
    loop: true,
    loopFillGroupWithBlank: true, // üõ†Ô∏è –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev'
    },
    thumbs: {
        swiper: thumbSwiper
    },
    breakpoints: {
        0: {
            slidesPerView: 1,
            slidesPerGroup: 1
        },
        640: {
            slidesPerView: 2,
            slidesPerGroup: 2
        },
        1024: {
            slidesPerView: 3,
            slidesPerGroup: 3
        }
    }
});

  // –õ–∞–π—Ç–±–æ–∫—Å
  const lightbox = GLightbox({
      selector: '.glightbox',
      loop: true,
      touchNavigation: true
  });
</script>

{% endblock %}
