{% extends 'base.html' %}
{% block content %}

<div class="tour-detail-wrapper">
  <div class="tour-summary glass" onclick="openFilterSheet()">
    <span id="summaryText">
      {{ tour.tourists or 1 }} —Ç—É—Ä–∏—Å—Ç ¬∑ {{ tour.nights }} –Ω–æ—á–µ–π
    </span>
    <span class="summary-edit">–ò–∑–º–µ–Ω–∏—Ç—å</span>
  </div>

  <!-- üåç –í–µ—Ä—Ö–Ω–∏–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–ª–æ–∫ -->
  <div class="tour-header glass">

    <div class="tour-head">

      <div class="tour-row">
        <span class="tour-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
        <div class="tour-direction">
          {{ tour.city }} ‚Üí {{ tour.country }}
        </div>
      </div>

      <div class="tour-row tour-hotel-line">
        <div class="tour-hotel">
          <span class="tour-label">–û—Ç–µ–ª—å</span>
          <div class="tour-hotel-name">
            {{ tour.hotel }}
          </div>
        </div>

        <button
          type="button"
          class="fav-btn"
          data-tour-id="{{ tour.id }}"
          onclick="addToFavorites(event, {{ tour.id }}, this)"
        >
          <img
            src="{{ url_for('static', filename='icons/heart-outline.png') }}"
            class="fav-heart"
            alt="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
          >
        </button>
      </div>

    </div>

  </div>

  <!-- üñº –ì–∞–ª–µ—Ä–µ—è (–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞) -->
  {% if tour.gallery %}
  <div class="gallery-block glass">
    <div class="swiper main-swiper">
      <div class="swiper-wrapper">
        {% for img in tour.gallery %}
        <div class="swiper-slide">
          <a href="{{ img if img.startswith('http') else url_for('static', filename='img/' + img) }}" class="glightbox" data-gallery="tour-gallery">
            <img src="{{ img if img.startswith('http') else url_for('static', filename='img/' + img) }}" alt="–§–æ—Ç–æ —Ç—É—Ä–∞">
          </a>
        </div>
        {% endfor %}
      </div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>

    <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã -->
    <div class="swiper thumb-swiper">
      <div class="swiper-wrapper">
        {% for img in tour.gallery %}
        <div class="swiper-slide">
          {% if img.startswith('http') %}
            <img src="{{ img }}">
          {% else %}
            <img src="{{ url_for('static', filename='img/' + img) }}">
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="tour-params glass">
    <div class="param"><span>–í—ã–ª–µ—Ç</span><strong>{{ tour.departure_date }}</strong></div>
    <div class="param"><span>–ù–æ—á–µ–π</span><strong>{{ tour.nights }}</strong></div>
    <div class="param"><span>–ü–∏—Ç–∞–Ω–∏–µ</span><strong>{{ tour.meal }}</strong></div>
    <div class="param"><span>–ü–µ—Ä–µ–ª—ë—Ç</span><strong>–í–∫–ª—é—á—ë–Ω</strong></div>
    <div class="param"><span>–ë–∞–≥–∞–∂</span><strong>20 –∫–≥</strong></div>
    <div class="param"><span>–ú–µ—Å—Ç–∞</span><strong>{{ tour.seats }}</strong></div>
  </div>

  <!-- üí¨ –û–ø–∏—Å–∞–Ω–∏–µ -->
  <div class="tour-description glass">
    {{ tour.description | truncate(600) }}
  </div>

</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<div class="tour-filter-overlay" id="filterOverlay" onclick="closeFilterSheet()"></div>
<div class="tour-filter-sheet" id="filterSheet">

  <div class="sheet-top">
    <span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—É—Ä–∞</span>
    <button class="apply-sheet-btn" onclick="applyFromSheet()">–ì–æ—Ç–æ–≤–æ</button>
  </div>

  <div class="sheet-content">
    <div class="sheet-row">
      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–∏—Å—Ç–æ–≤</label>
      <input type="number" id="sheetTourists" min="1" value="1">
    </div>

    <div class="sheet-row">
      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π</label>
      <select id="sheetNights">
        {% for n in range(2, 21) %}
          <option value="{{ n }}" {% if n == tour.nights %}selected{% endif %}>
            {{ n }} –Ω–æ—á–µ–π
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

</div>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  color: #4b3821;
  margin: 0;
  padding: 0;
}

/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.tour-detail-wrapper {
  max-width: 1100px;
  margin: 100px auto 80px;
  padding: 0 20px;
}

/* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –±–ª–æ–∫–∏ */
.glass {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 20px 25px;
  margin-bottom: 25px;
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
}

/* –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ */
.tour-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}
.tour-header h1 {
  font-size: 1.5rem;
  margin: 0;
}
.tour-header p {
  margin: 0;
  font-size: 15px;
}

/* –ú–∏–Ω–∏-—Ñ–∏–ª—å—Ç—Ä */
.mini-filter {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-end;
  gap: 10px;
}
.mini-filter input, .mini-filter select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0,0,0,0.2);
  background: rgba(255,255,255,0.7);
}
.mini-filter button {
  background: #c7934b;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.mini-filter button:hover {
  background: #b37d3e;
  transform: translateY(-1px);
}

/* –°–ª–∞–π–¥–µ—Ä */
.gallery-block img {
  width: 100%;
  height: 350px;
  object-fit: cover;
  border-radius: 12px;
}
.thumb-swiper {
  margin-top: 12px;
  padding: 10px;
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
}
.thumb-swiper .swiper-slide {
  height: 60px;
  cursor: pointer;
}
.thumb-swiper .swiper-slide img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
  border: 2px solid #fff;
  transition: transform 0.2s ease;
}
.thumb-swiper .swiper-slide img:hover {
  transform: scale(1.05);
}
.swiper-button-next, .swiper-button-prev {
  color: #c7934b;
}

/* –û–ø–∏—Å–∞–Ω–∏–µ */
.tour-info-card p {
  margin-bottom: 10px;
}
.back-btn {
  display: inline-block;
  margin-top: 15px;
  text-decoration: none;
  background: #c7934b;
  color: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  transition: all 0.3s ease;
}
.back-btn:hover {
  background: #b37d3e;
}

/* –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
.tour-fixed-buttons {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;          /* –ü–ö */
  display: flex;
  background: rgba(255,255,255,0.3);
  padding: 12px 20px;
  box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
  z-index: 1000;
}

/* üì± –º–æ–±–∏–ª–∫–∞ ‚Äî —Å–¥–≤–∏–≥–∞–µ–º –∫–Ω–æ–ø–∫—É –í–´–®–ï –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é */
@media (max-width: 768px) {
  .tour-fixed-buttons {
    bottom: var(--bottom-nav-height);
  }
}

.btn-book {
  background: #2ecc71;
  color: white;
  font-size: 16px;
  font-weight: 600;
  padding: 12px;
  border: none;
  border-radius: 10px;
  width: 100%;
  cursor: pointer;
}
.btn-book:hover {
  background: #27ae60;
}

/* üì± –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 768px) {
  .tour-header { flex-direction: column; align-items: flex-start; }
  .gallery-block img { height: 240px; }
}

.favorite-btn {
  display: inline-block;
  margin-top: 10px;
  padding: 6px 12px;
  border-radius: 10px;
  background: rgba(255, 215, 0, 0.2);
  color: #8a6d1d;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s ease;
}

.favorite-btn:hover {
  background: rgba(255, 215, 0, 0.35);
  transform: translateY(-1px);
}

.tour-params {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
}

.param {
  background: rgba(255,255,255,0.5);
  border-radius: 12px;
  padding: 12px;
  text-align: center;
}

.param span {
  display: block;
  font-size: 13px;
  color: #7a6a55;
}

.param strong {
  font-size: 15px;
  color: #4b3821;
}

@media (max-width: 768px) {
  .tour-params {
    grid-template-columns: repeat(2, 1fr);
  }
}

.tour-head {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

/* –û–±—â–∞—è —Å—Ç—Ä–æ–∫–∞ */
.tour-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* –õ–µ–π–±–ª—ã */
.tour-label {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: #8b7a65;
}

/* –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
.tour-direction {
  font-size: 16px;
  font-weight: 600;
  color: #3f2f1e;
}

/* –°—Ç—Ä–æ–∫–∞ –æ—Ç–µ–ª—è + —Å–µ—Ä–¥—Ü–µ */
.tour-hotel-line {
  flex-direction: row;
  align-items: center;        /* üî• –í–ê–ñ–ù–û */
  justify-content: space-between;
  gap: 14px;
}

/* –ë–ª–æ–∫ —Å –æ—Ç–µ–ª–µ–º */
.tour-hotel {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è */
.tour-hotel-name {
  font-size: 18px;            /* üî• –ö–†–£–ü–ù–ï–ï */
  font-weight: 600;
  line-height: 1.3;
  color: #2f2418;
}

/* –°–µ—Ä–¥–µ—á–∫–æ */
.fav-btn {
  background: none;
  border: none;
  padding: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.fav-heart {
  width: 30px;
  height: 30px;
  transition: transform 0.15s ease;
}

.fav-btn:active .fav-heart {
  transform: scale(0.9);
}

/* üì± –º–æ–±–∏–ª–∫–∞ */
@media (max-width: 768px) {
  .tour-hotel-name {
    font-size: 16px;
  }

  .tour-direction {
    font-size: 15px;
  }

  .fav-heart {
    width: 26px;
    height: 26px;
  }
}

.open-filter-btn {
  margin-top: 8px;
  align-self: flex-start;

  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(6px);

  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 10px;
  padding: 8px 14px;

  font-size: 14px;
  font-weight: 500;
  color: #3f2f1e;

  cursor: pointer;
}

.open-filter-btn:active {
  transform: scale(0.97);
}

/* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
.sheet-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(4px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 10000;
}

/* –í–ï–†–•–ù–Ø–Ø –®–¢–û–†–ö–ê */
.filter-sheet {
  position: fixed;
  top: -50vh;              /* üî• –°–ü–†–Ø–¢–ê–ù–ê */
  left: 0;
  right: 0;
  height: 50vh;            /* üî• –ü–û–õ –≠–ö–†–ê–ù–ê */
  background: rgba(255,255,255,0.97);

  border-radius: 0 0 20px 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);

  transition: top 0.35s ease;
  z-index: 10001;

  display: flex;
  flex-direction: column;
}

/* –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
.filter-sheet.active {
  top: 0;
}

.sheet-overlay.active {
  opacity: 1;
  pointer-events: all;
}

/* —Ä—É—á–∫–∞ */
.sheet-handle {
  width: 40px;
  height: 4px;
  background: #ccc;
  border-radius: 2px;
  margin: 14px auto 0;
}

.filter-sheet h3 {
  margin: 0 0 18px;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
}

/* –ø–æ–ª—è */
.sheet-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 14px;
}

.sheet-row label {
  font-size: 13px;
  color: #6b5a44;
}

.sheet-row input,
.sheet-row select {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.15);
  font-size: 15px;
}

/* –∫–Ω–æ–ø–∫–∞ */
.apply-sheet-btn {
  width: 100%;
  padding: 12px;
  margin-top: 10px;

  background: #c7934b;
  color: #fff;
  border: none;
  border-radius: 12px;

  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

.apply-sheet-btn:active {
  transform: scale(0.97);
}

.sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.sheet-header span {
  font-size: 16px;
  font-weight: 600;
  color: #2f2418;
}

.sheet-header button {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #555;
}

.sheet-top {
  position: sticky;
  top: 0;

  display: flex;
  justify-content: space-between;
  align-items: center;

  padding: 14px 16px;
  background: rgba(255,255,255,0.95);
  border-bottom: 1px solid rgba(0,0,0,0.08);

  font-size: 15px;
  font-weight: 600;
}

.sheet-content {
  padding: 16px;
  overflow-y: auto;
  flex: 1;
}

.apply-sheet-btn {
  background: #c7934b;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.tour-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;

  margin-top: 12px;
  padding: 12px 16px;

  cursor: pointer;
}

.summary-edit {
  font-size: 13px;
  color: #c7934b;
  font-weight: 500;
}

/* ‚úÖ Overlay –º–∏–Ω–∏-—Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π, –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å base.html */
.tour-filter-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(4px);
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s ease;
  z-index: 10000; /* –Ω–∏–∂–µ, —á–µ–º base sheet (100002), –Ω–æ –º—ã –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º base sheet */
}

.tour-filter-overlay.active{
  opacity: 1;
  pointer-events: all;
}

/* ‚úÖ –®—Ç–æ—Ä–∫–∞ –º–∏–Ω–∏-—Ñ–∏–ª—å—Ç—Ä–∞ */
.tour-filter-sheet{
  position: fixed;
  top: -50vh;
  left: 0;
  right: 0;
  height: 50vh;
  background: rgba(255,255,255,0.97);
  border-radius: 0 0 20px 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  transition: top .35s ease;
  z-index: 10001;
  display: flex;
  flex-direction: column;
}

.tour-filter-sheet.active{
  top: 0;
}

</style>

<script>
/* Swiper */
const thumbSwiper = new Swiper('.thumb-swiper', {
  spaceBetween: 8,
  slidesPerView: 5,
  watchSlidesProgress: true,
  breakpoints: { 768: { slidesPerView: 8 } }
});

const mainSwiper = new Swiper('.main-swiper', {
  spaceBetween: 10,
  loop: true,
  navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
  thumbs: { swiper: thumbSwiper },
  breakpoints: {
    0: { slidesPerView: 1 },
    640: { slidesPerView: 2 },
    1024: { slidesPerView: 3 }
  }
});
/* === –®–¢–û–†–ö–ê === */
function openFilterSheet() {
  document.getElementById('filterSheet')?.classList.add('active');
  document.getElementById('filterOverlay')?.classList.add('active');
}

function closeFilterSheet() {
  document.getElementById('filterSheet')?.classList.remove('active');
  document.getElementById('filterOverlay')?.classList.remove('active');
}

/* === –ö–ù–û–ü–ö–ê "–ü–†–ò–ú–ï–ù–ò–¢–¨" –í –®–¢–û–†–ö–ï === */
function applyFromSheet() {
  applyDates();        // —Å—á–∏—Ç–∞–µ–º —Ü–µ–Ω—É
  closeFilterSheet();  // –∑–∞–∫—Ä—ã–≤–∞–µ–º —à—Ç–æ—Ä–∫—É
}

/* === –¢–í–û–Ø –§–û–†–ú–£–õ–ê (–ù–ï –ú–ï–ù–Ø–õ) === */
function applyDates() {
  const people =
    parseInt(document.getElementById("sheetTourists")?.value) || 1;

  const nights =
    parseInt(document.getElementById("sheetNights")?.value) || 1;

  const basePrice = {{ tour.price }};
  const baseNights = {{ tour.nights }};
  const pricePerNight = basePrice / baseNights;
  const total = Math.round(pricePerNight * people * nights);

  // —Ñ–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const fPeople = document.getElementById("formTourists");
  const fNights = document.getElementById("formNights");
  const fPrice  = document.getElementById("formPrice");

  if (fPeople) fPeople.value = people;
  if (fNights) fNights.value = nights;
  if (fPrice)  fPrice.value = total;

  // –∫–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É
  const summary = document.getElementById("summaryText");
  if (summary) {
    summary.innerText = `${people} —Ç—É—Ä–∏—Å—Ç ¬∑ ${nights} –Ω–æ—á–µ–π`;
  }
  const btn = document.getElementById("bookButton");
  if (btn) {
    btn.innerText = `–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä –∑–∞ ${total.toLocaleString()} ‚Ç∏`;
  }
}
</script>

{% endblock %}
