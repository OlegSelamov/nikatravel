{% extends 'base.html' %}
{% block content %}

<div class="tour-detail-wrapper">

  <!-- üåç –í–µ—Ä—Ö–Ω–∏–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–ª–æ–∫ -->
  <div class="tour-header glass">
    <div class="tour-header-info">
      <h1>{{ tour.city }} ‚Äî {{ tour.country }}</h1>
      <p><strong>–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</strong> {{ tour.departure_date }}</p>
      <button
        type="button"
        class="fav-btn add-to-fav-btn"
        data-tour-id="{{ tour_id }}"
        onclick="addToFavorites(event, {{ tour_id }}, this)"
      >
        <img
          src="{{ url_for('static', filename='icons/heart-outline.png') }}"
          class="fav-heart"
          alt="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
        >
      </button>
    </div>

    <div class="mini-filter">
      <label>–¢—É—Ä–∏—Å—Ç–æ–≤:</label>
      <input type="number" id="tourists" min="1" value="{{ tour.tourists or 1 }}">
      <label>–ù–æ—á–µ–π:</label>
      <select id="nights-select">
        {% for n in range(2, 21) %}
          <option value="{{ n }}" {% if n == tour.nights %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
      <button onclick="applyDates()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>

  <!-- üñº –ì–∞–ª–µ—Ä–µ—è (–≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞) -->
  {% if tour.gallery %}
  <div class="gallery-block glass">
    <div class="swiper main-swiper">
      <div class="swiper-wrapper">
        {% for img in tour.gallery %}
        <div class="swiper-slide">
          <a href="{{ img if img.startswith('http') else url_for('static', filename='img/' + img) }}" class="glightbox" data-gallery="tour-gallery">
            <img src="{{ img if img.startswith('http') else url_for('static', filename='img/' + img) }}" alt="–§–æ—Ç–æ —Ç—É—Ä–∞">
          </a>
        </div>
        {% endfor %}
      </div>
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>

    <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã -->
    <div class="swiper thumb-swiper">
      <div class="swiper-wrapper">
        {% for img in tour.gallery %}
        <div class="swiper-slide">
          {% if img.startswith('http') %}
            <img src="{{ img }}">
          {% else %}
            <img src="{{ url_for('static', filename='img/' + img) }}">
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- üí¨ –û–ø–∏—Å–∞–Ω–∏–µ -->
  <div class="tour-info-card glass">
    <p>{{ tour.description }}</p>
    <a href="{{ url_for('filter_page') }}" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ç—É—Ä–∞</a>
  </div>

  <!-- üîò –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <form action="{{ url_for('confirmation_page', tour_id=tour_id) }}" method="get" id="bookForm">
    <input type="hidden" name="departure_date" value="{{ tour.departure_date }}">
    <input type="hidden" name="tourists" id="formTourists" value="1">
    <input type="hidden" name="nights" id="formNights" value="{{ tour.nights }}">
    <input type="hidden" name="total_price" id="formPrice" value="{{ tour.price }}">
    <div class="tour-fixed-buttons">
      <button type="submit" id="bookButton" class="btn-book">
        –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä –∑–∞ {{ tour.price | default(0) }} ‚Ç∏
      </button>
    </div>
  </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  color: #4b3821;
  margin: 0;
  padding: 0;
}

/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
.tour-detail-wrapper {
  max-width: 1100px;
  margin: 100px auto 80px;
  padding: 0 20px;
}

/* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –±–ª–æ–∫–∏ */
.glass {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 20px 25px;
  margin-bottom: 25px;
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
}

/* –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ */
.tour-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}
.tour-header h1 {
  font-size: 1.5rem;
  margin: 0;
}
.tour-header p {
  margin: 0;
  font-size: 15px;
}

/* –ú–∏–Ω–∏-—Ñ–∏–ª—å—Ç—Ä */
.mini-filter {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-end;
  gap: 10px;
}
.mini-filter input, .mini-filter select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid rgba(0,0,0,0.2);
  background: rgba(255,255,255,0.7);
}
.mini-filter button {
  background: #c7934b;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.mini-filter button:hover {
  background: #b37d3e;
  transform: translateY(-1px);
}

/* –°–ª–∞–π–¥–µ—Ä */
.gallery-block img {
  width: 100%;
  height: 350px;
  object-fit: cover;
  border-radius: 12px;
}
.thumb-swiper {
  margin-top: 12px;
  padding: 10px;
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
}
.thumb-swiper .swiper-slide {
  height: 60px;
  cursor: pointer;
}
.thumb-swiper .swiper-slide img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
  border: 2px solid #fff;
  transition: transform 0.2s ease;
}
.thumb-swiper .swiper-slide img:hover {
  transform: scale(1.05);
}
.swiper-button-next, .swiper-button-prev {
  color: #c7934b;
}

/* –û–ø–∏—Å–∞–Ω–∏–µ */
.tour-info-card p {
  margin-bottom: 10px;
}
.back-btn {
  display: inline-block;
  margin-top: 15px;
  text-decoration: none;
  background: #c7934b;
  color: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  transition: all 0.3s ease;
}
.back-btn:hover {
  background: #b37d3e;
}

/* –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
.tour-fixed-buttons {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;          /* –ü–ö */
  display: flex;
  background: rgba(255,255,255,0.3);
  padding: 12px 20px;
  box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
  z-index: 1000;
}

/* üì± –º–æ–±–∏–ª–∫–∞ ‚Äî —Å–¥–≤–∏–≥–∞–µ–º –∫–Ω–æ–ø–∫—É –í–´–®–ï –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é */
@media (max-width: 768px) {
  .tour-fixed-buttons {
    bottom: var(--bottom-nav-height);
  }
}

.btn-book {
  background: #2ecc71;
  color: white;
  font-size: 16px;
  font-weight: 600;
  padding: 12px;
  border: none;
  border-radius: 10px;
  width: 100%;
  cursor: pointer;
}
.btn-book:hover {
  background: #27ae60;
}

/* üì± –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media (max-width: 768px) {
  .tour-header { flex-direction: column; align-items: flex-start; }
  .gallery-block img { height: 240px; }
}

.favorite-btn {
  display: inline-block;
  margin-top: 10px;
  padding: 6px 12px;
  border-radius: 10px;
  background: rgba(255, 215, 0, 0.2);
  color: #8a6d1d;
  font-size: 13px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s ease;
}

.favorite-btn:hover {
  background: rgba(255, 215, 0, 0.35);
  transform: translateY(-1px);
}

</style>

<script>
/* Swiper */
const thumbSwiper = new Swiper('.thumb-swiper', {
  spaceBetween: 8,
  slidesPerView: 5,
  watchSlidesProgress: true,
  breakpoints: { 768: { slidesPerView: 8 } }
});

const mainSwiper = new Swiper('.main-swiper', {
  spaceBetween: 10,
  loop: true,
  navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
  thumbs: { swiper: thumbSwiper },
  breakpoints: {
    0: { slidesPerView: 1 },
    640: { slidesPerView: 2 },
    1024: { slidesPerView: 3 }
  }
});

/* Lightbox */
const lightbox = GLightbox({ selector: '.glightbox', loop: true });

/* –ú–∏–Ω–∏ —Ñ–∏–ª—å—Ç—Ä */
function applyDates() {
  const people = parseInt(document.getElementById("tourists").value) || 1;
  const nights = parseInt(document.getElementById("nights-select").value) || 1;
  const basePrice = {{ tour.price }};
  const baseNights = {{ tour.nights }};
  const pricePerNight = basePrice / baseNights;
  const total = Math.round(pricePerNight * people * nights);

  document.getElementById("formTourists").value = people;
  document.getElementById("formNights").value = nights;
  document.getElementById("formPrice").value = total;
  document.getElementById("bookButton").innerText = `–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä –∑–∞ ${total.toLocaleString()} ‚Ç∏`;
}
</script>

{% endblock %}
