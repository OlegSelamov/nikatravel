{% extends "base.html" %}

{% block content %}
<div class="flights-container" style="max-width:1200px;margin:0 auto;padding:20px;">
    <h1 style="text-align:center;margin-bottom:20px;color:#d48b3d;">Поиск авиабилетов</h1>
	  <div style="background:#fff8f0;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <script async src="https://tpwdg.com/content?currency=kzt&trs=448848&shmarker=664464&searchUrl=www.aviasales.kz%2Fsearch&locale=ru&powered_by=true&origin=ALA&destination=AUH&one_way=false&only_direct=false&period=year&range=7%2C14&primary=%23B84104ff&color_background=%23FEDD96ff&dark=%23823B02ff&light=%23F8E6D8ff&achieve=%23DD5F07ff&promo_id=4041&campaign_id=100" charset="utf-8"></script>
      </div>
</div>

<style>
.glass-widget {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    padding: 20px;
}
</style>

    {% if flights %}
    <h2 style="margin-top:30px;color:#d48b3d;">Найденные варианты</h2>
    <div style="overflow-x:auto;margin-top:15px;">
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr style="background:#f4e2d8;">
                    <th style="padding:10px;border:1px solid #ddd;">Авиакомпания</th>
                    <th style="padding:10px;border:1px solid #ddd;">Цена</th>
                    <th style="padding:10px;border:1px solid #ddd;">Дата вылета</th>
                    <th style="padding:10px;border:1px solid #ddd;">Купить</th>
                </tr>
</thead>
<tbody>
  {% for f in flights %}
  <tr>
    <td style="padding:8px;border:1px solid #ddd;">{{ f.airline or '-' }}</td>
    <td style="padding:8px;border:1px solid #ddd;" class="rub-price" data-price="{{ f.price }}">{{ f.price }} RUB</td>
    <td style="padding:8px;border:1px solid #ddd;">{{ (f.departure_at or '')[:10] }}</td>
    <td style="padding:8px;border:1px solid #ddd;">
      <a href="{{ url_for('avia_frame', origin=origin, destination=destination, depart_date=(f.departure_at or '')[:10]) }}"
         style="color:white;background:#e76f51;padding:6px 12px;border-radius:4px;text-decoration:none;">
          Забронировать
      </a>
    </td>
  </tr>
  {% endfor %}
</tbody>
        </table>
    </div>
    {% elif flights is not none %}
        <p style="margin-top:20px;color:red;">По вашему запросу билетов не найдено.</p>
    {% endif %}
</div>

<style>
.autocomplete-list {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    z-index: 9999;
    max-height: 200px;
    overflow-y: auto;
    width: calc(100% - 20px);
}
.autocomplete-list div {
    padding: 8px;
    cursor: pointer;
}
.autocomplete-list div:hover {
    background: #f4e2d8;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const fallbackRate = 5.20; // резервный курс RUB→KZT

    fetch("https://api.exchangerate.host/latest?base=RUB&symbols=KZT")
        .then(res => res.json())
        .then(data => {
            const rate = data?.rates?.KZT || fallbackRate;
            convertPrices(rate);
        })
        .catch(() => {
            convertPrices(fallbackRate);
        });

    function convertPrices(rate) {
        document.querySelectorAll(".rub-price").forEach(el => {
            const rub = parseFloat(el.dataset.price);
            if (!isNaN(rub)) {
                const kzt = Math.round(rub * rate).toLocaleString('ru-RU');
                el.textContent = `${kzt} KZT`;
            }
        });
    }
});
</script>

<script>
function setupAutocomplete(inputId, listId) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);

    input.addEventListener("input", function() {
        const query = this.value.trim();
        list.innerHTML = "";
        if (query.length < 2) return;

        fetch(`https://autocomplete.travelpayouts.com/places2?term=${query}&locale=ru`)
            .then(res => res.json())
            .then(data => {
                data.forEach(place => {
                    const div = document.createElement("div");
                    div.textContent = `${place.name} (${place.code})`;
                    div.addEventListener("click", () => {
                        input.value = place.code;
                        list.innerHTML = "";
                    });
                    list.appendChild(div);
                });
            });
    });

    document.addEventListener("click", function(e) {
        if (!list.contains(e.target) && e.target !== input) {
            list.innerHTML = "";
        }
    });
}

setupAutocomplete("origin", "origin-list");
setupAutocomplete("destination", "destination-list");
</script>
{% endblock %}
