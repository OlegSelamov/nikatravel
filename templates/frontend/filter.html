{% extends 'base.html' %}
{% block content %}
<!-- Подключение flatpickr и русской локали -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

<div class="tour-filter-container">
  <label>Страна:
    <select id="countrySelect"></select>
  </label>
  <label>Город вылета:
    <select id="citySelect"></select>
  </label>
  <label>Дата вылета:
    <input type="text" id="dateInput" placeholder="Выберите дату" readonly>
  </label>
</div>

<!-- Блок доступных туров -->
<div id="available-tours">
  <h2>Доступные туры</h2>
  <div id="tours-list" class="tour-cards-grid"></div>
</div>

<script>
let allTours = [];
let calendarInstance = null;

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('available-tours').style.display = 'none';
  loadData();
});

async function loadData() {
  try {
    const res = await fetch('data/filter.json?t=' + Date.now());
    allTours = await res.json();
    console.log("JSON загружен:", allTours);
    populateCountrySelect();
    restoreFilterState();
  } catch (e) {
    console.error("Ошибка загрузки JSON:", e);
  }
}

function populateCountrySelect() {
  const countrySelect = document.getElementById('countrySelect');
  const countries = [...new Set(allTours.map(t => t.country.trim().replace(/^-/, '').trim()))].sort();
  countrySelect.innerHTML = '<option disabled selected>Выберите страну</option>' +
    countries.map(c => `<option value="${c}">${c}</option>`).join('');
}

document.getElementById('countrySelect').addEventListener('change', e => {
  const selected = e.target.value;
  populateCitySelect(selected);
});

function populateCitySelect(country, preselectCity = null) {
  const cities = [...new Set(allTours
    .filter(t => t.country.trim().replace(/^-/, '').trim() === country.trim().replace(/^-/, '').trim())
    .map(t => t.city.trim().replace(/^-/, '').trim())
	)].sort();
  const citySelect = document.getElementById('citySelect');
  citySelect.innerHTML = '<option disabled selected>Выберите город</option>' +
    cities.map(c => `<option value="${c}">${c}</option>`).join('');
  if (preselectCity) {
    citySelect.value = preselectCity;
  }
  document.getElementById('citySelect').addEventListener('change', updateCalendar);
}

function updateCalendar(preselectDate = null) {
  const selectedCountry = document.getElementById('countrySelect').value;
  const selectedCity = document.getElementById('citySelect').value;
  const dates = new Set();

  allTours.forEach(t => {
    if (
      t.country && t.city && t.dates_prices &&
      t.country.trim().toLowerCase() === selectedCountry.trim().toLowerCase() &&
      t.city.trim().toLowerCase() === selectedCity.trim().toLowerCase()
    ) {
      t.dates_prices.forEach(dp => {
        dates.add(dp.date.trim());
      });
    }
  });

  const availableDates = Array.from(dates);
  console.log("Даты для календаря:", availableDates);

  if (calendarInstance) {
    calendarInstance.destroy();
  }

  calendarInstance = flatpickr("#dateInput", {
    dateFormat: "d.m.Y",
    enable: availableDates,
    locale: flatpickr.l10ns.ru,
    defaultDate: preselectDate || null,
    onChange: function(selectedDates, dateStr) {
      console.log("Выбрана дата:", dateStr);
      filterTours(dateStr);
    }
  });

  if (preselectDate) {
    filterTours(preselectDate);
  }
}

// Приведение даты YYYY-MM-DD → DD.MM.YYYY
function formatDateToDDMMYYYY(dateStr) {
  if (dateStr && dateStr.includes('-')) {
    const [y, m, d] = dateStr.split('-');
    return `${d}.${m}.${y}`;
  }
  return dateStr;
}

function filterTours(selectedDate) {
  const selectedCountry = document.getElementById('countrySelect').value;
  const selectedCity = document.getElementById('citySelect').value;

  const result = [];

  allTours.forEach(t => {
    if (
      t.country && t.city && t.dates_prices &&
      t.country.trim().toLowerCase() === selectedCountry.trim().toLowerCase() &&
      t.city.trim().toLowerCase() === selectedCity.trim().toLowerCase()
    ) {
      t.dates_prices.forEach(dp => {
        if (
          dp.date.trim() === selectedDate.trim() ||
          dp.date.trim() === formatDateToDDMMYYYY(selectedDate.trim())
        ) {
        // считаем старую цену (+20%) и рассрочку (+12% / 12 мес)
        let oldPrice = Math.round(dp.price * 1.20);
        let discountPercent = Math.round((oldPrice - dp.price) / oldPrice * 100);
        let pricePerMonth = Math.round((dp.price * 1.12) / 12);

        result.push({
          ...t,
          price: dp.price,
          date: dp.date,
          old_price: oldPrice,
          discount_percent: discountPercent,
          price_per_month: pricePerMonth
        });
        }
      });
    }
  });

  localStorage.setItem('tourFilter', JSON.stringify({
    country: selectedCountry,
    city: selectedCity,
    date: selectedDate
  }));

  document.getElementById('available-tours').style.display = 'block';
  renderNativeCards(result);
  document.getElementById('available-tours').scrollIntoView({ behavior: 'smooth' });
}

function renderNativeCards(tours) {
  const container = document.getElementById('tours-list');
  if (tours.length === 0) {
    container.innerHTML = '<p>Нет туров на выбранную дату</p>';
    return;
  }

  container.innerHTML = tours.map((t, index) => `
      <a href="/tour/${t.id}?departure_date=${encodeURIComponent(t.date)}&price=${t.price}" class="tour-card-link">
      <div class="tour-card-visual">
        <div class="tour-image-box">
          ${t.installment_months ? `<div class="tour-badge-left">0-0-${t.installment_months}</div>` : ''}
          ${t.discount_percent ? `<div class="tour-badge-right">-${t.discount_percent}%</div>` : ''}
          ${t.image && t.image.startsWith('http') 
            ? `<img src="${t.image}" alt="${t.hotel}">`
            : `<img src="/static/img/${t.image}" alt="${t.hotel}">`}
          <div class="tour-location">${t.country}, ${t.city}</div>
        </div>
        <div class="tour-info">
          <h3>${t.hotel}${t.stars ? ` ${t.stars}*` : ''}</h3>
          <div class="tour-price">${t.price} ₸</div>
          ${t.old_price ? `<div class="tour-old-price">${t.old_price} ₸</div>` : ''}
          ${t.price_per_month ? `<div class="tour-monthly">${t.price_per_month} ₸ x${t.installment_months}</div>` : ''}
        </div>
      </div>
    </a>
  `).join('');
}

function restoreFilterState() {
  const saved = localStorage.getItem('tourFilter');
  if (!saved) return;

  const { country, city, date } = JSON.parse(saved);

  document.getElementById('countrySelect').value = country;
  populateCitySelect(country, city);

  // задержка для гарантии загрузки городов и календаря
  setTimeout(() => {
    updateCalendar(date);
  }, 200);
}
</script>

<style>
.tour-filter-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
  background: rgba(255, 248, 238, 0.4); /* полупрозрачный фон */;
  padding: 15px;
  border-radius: 0px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  backdrop-filter: blur(6px); /* лёгкое размытие фона */
}
.tour-filter-container label {
  font-size: 14px;
  color: #6a5037;
  display: flex;
  flex-direction: column;
}
.tour-filter-container select,
.tour-filter-container input {
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}
#available-tours {
  margin-top: 20px;
}
#available-tours h2 {
  text-align: center;
  font-size: 1.8rem;
  margin-bottom: 20px;
  color: #6a5037;
}
#tours-list {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

  .tour-card-visual {
    width: 100%;
    height: 100%; /* чтобы тянулось */
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.7); /* полупрозрачный белый фон */
	backdrop-filter: blur(10px);            /* размытие фона позади */
    border-radius: 16px;
	border: 1px solid rgba(255, 255, 255, 0.3); /* лёгкая белая рамка */
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
	transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
  }

  .tour-card-visual:hover {
    transform: scale(1.03);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
  }

@media (max-width: 1024px) {
  #tours-list {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  #tours-list {
    display: grid;
    grid-template-columns: repeat(2, calc(50% - 6px));
    gap: 12px;
  }

  .tour-card-link {
    display: block;
    width: 100%;
  }
  
  .tour-image-box {
    flex: 0 0 140px; /* фиксированная высота блока с картинкой */
    position: relative;
  }

  .tour-image-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .tour-info {
    flex: 1;
    padding: 8px;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* чтобы цена всегда была внизу */
  }
}

@media (max-width: 480px) {
  /* для совсем маленьких экранов можно оставить по одной карточке */
  #tours-list {
    grid-template-columns: repeat(2, calc(50% - 6px));
  }
}
</style>

{% endblock %}





