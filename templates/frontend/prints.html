{% extends "base.html" %}
{% block content %}
<div class="editor-wrapper">
  <h2>ÐŸÑ€Ð¸Ð½Ñ‚Ñ‹ Ð½Ð° Ð·Ð°ÐºÐ°Ð· â€” Nika Wear</h2>

  <div class="editor">
    <!-- Ð¥Ð¾Ð»ÑÑ‚ -->
    <canvas id="mockupCanvas" width="500" height="600"></canvas>

    <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ -->
    <div class="controls">
      <label>Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾:
        <input type="file" id="uploadImage" accept="image/*">
      </label>

      <label>Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ†Ð²ÐµÑ‚ Ð¾Ð´ÐµÐ¶Ð´Ñ‹:
        <input type="color" id="shirtColor" value="#ffffff">
      </label>

      <label>Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ:
        <select id="modelSelect">
          <option value="tshirt">Ð¤ÑƒÑ‚Ð±Ð¾Ð»ÐºÐ°</option>
          <option value="hoodie">Ð¥ÑƒÐ´Ð¸</option>
          <option value="cap">ÐšÐµÐ¿ÐºÐ°</option>
        </select>
      </label>

      <button id="saveBtn">ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¼Ð°ÐºÐµÑ‚</button>
      <button id="orderBtn">ðŸ›’ Ð—Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<style>
.editor-wrapper {
  text-align: center;
  padding: 20px;
}

.editor {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 30px auto;
  gap: 40px;
  max-width: 1200px;
}

canvas {
  border: 1px solid #ccc;
  background: #fefefe;
  cursor: grab;
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding: 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

button, input[type="color"], input[type="file"], select {
  padding: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  cursor: pointer;
}

button:hover {
  background: #d4a373;
  color: white;
}
</style>

<script>
const canvas = document.getElementById("mockupCanvas");
const ctx = canvas.getContext("2d");

let uploadedImg = null;
let shirtColor = "#ffffff";
let model = "tshirt";

// ÐšÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¸Ð½Ñ‚Ð°
let imgX = 150, imgY = 180, imgW = 200, imgH = 200;
let dragging = false, offsetX, offsetY;

// ÐœÐ°ÐºÐµÑ‚Ñ‹ PNG (Ð¿Ñ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ñ‹Ðµ)
const mockups = {
  tshirt: "/static/mockups/tshirt.png",
  hoodie: "/static/mockups/hoodie.png",
  cap: "/static/mockups/cap.png"
};

let mockupImg = new Image();
mockupImg.src = mockups[model];

// ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ°
function drawMockup() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 1. ÐšÑ€Ð°ÑÐ¸Ð¼ Ñ„ÑƒÑ‚Ð±Ð¾Ð»ÐºÑƒ (multiply)
  ctx.drawImage(mockupImg, 0, 0, canvas.width, canvas.height);
  ctx.globalCompositeOperation = "multiply";
  ctx.fillStyle = shirtColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // 2. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
  ctx.globalCompositeOperation = "source-over";

  // 3. ÐšÐ»Ð°Ð´Ñ‘Ð¼ Ñ„Ð¾Ñ‚Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
  if (uploadedImg) {
    ctx.drawImage(uploadedImg, imgX, imgY, imgW, imgH);
  }

  // 4. ÐœÐ°ÐºÐµÑ‚ ÑÐ½Ð¾Ð²Ð° (ÑˆÐ²Ñ‹, ÑÐºÐ»Ð°Ð´ÐºÐ¸)
  ctx.drawImage(mockupImg, 0, 0, canvas.width, canvas.height);
}

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð¾Ñ‚Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
document.getElementById("uploadImage").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    uploadedImg = new Image();
    uploadedImg.onload = drawMockup;
    uploadedImg.src = evt.target.result;
  };
  reader.readAsDataURL(file);
});

// Ð¦Ð²ÐµÑ‚
document.getElementById("shirtColor").addEventListener("input", (e) => {
  shirtColor = e.target.value;
  drawMockup();
});

// ÐœÐ¾Ð´ÐµÐ»ÑŒ
document.getElementById("modelSelect").addEventListener("change", (e) => {
  model = e.target.value;
  mockupImg.src = mockups[model];
  mockupImg.onload = drawMockup;
});

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ
document.getElementById("saveBtn").addEventListener("click", () => {
  const link = document.createElement("a");
  link.download = "nika_wear_mockup.png";
  link.href = canvas.toDataURL();
  link.click();
});

// Ð—Ð°ÐºÐ°Ð·
document.getElementById("orderBtn").addEventListener("click", () => {
  alert("Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ñ„Ð¾Ñ€Ð¼Ð° Ð·Ð°ÐºÐ°Ð·Ð° ðŸš€");
});

// ÐŸÐµÑ€ÐµÑ‚Ð°ÑÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¸Ð½Ñ‚Ð°
canvas.addEventListener("mousedown", (e) => {
  if (!uploadedImg) return;
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  if (mouseX >= imgX && mouseX <= imgX+imgW && mouseY >= imgY && mouseY <= imgY+imgH) {
    dragging = true;
    offsetX = mouseX - imgX;
    offsetY = mouseY - imgY;
    canvas.style.cursor = "grabbing";
  }
});

canvas.addEventListener("mousemove", (e) => {
  if (dragging && uploadedImg) {
    const rect = canvas.getBoundingClientRect();
    imgX = e.clientX - rect.left - offsetX;
    imgY = e.clientY - rect.top - offsetY;
    drawMockup();
  }
});

canvas.addEventListener("mouseup", () => {
  dragging = false;
  canvas.style.cursor = "grab";
});

// ÐœÐ°ÑÑˆÑ‚Ð°Ð± ÐºÐ¾Ð»ÐµÑÐ¸ÐºÐ¾Ð¼
canvas.addEventListener("wheel", (e) => {
  if (uploadedImg) {
    e.preventDefault();
    const scale = e.deltaY < 0 ? 1.05 : 0.95;
    imgW *= scale;
    imgH *= scale;
    drawMockup();
  }
});

mockupImg.onload = drawMockup;
</script>
{% endblock %}
