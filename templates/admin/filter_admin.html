<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Фильтр туров</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <style>
        body {
          font-family: sans-serif;
          background-color: #f8f5f0;
          margin: 20px;
        }

        .navbar {
          margin-bottom: 20px;
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
        }

        .navbar a {
          text-decoration: none;
          background: rgba(255,255,255,0.5);
          padding: 8px 15px;
          border-radius: 8px;
          font-weight: 600;
          color: #5a4633;
          transition: 0.3s;
          backdrop-filter: blur(6px);
        }

        .navbar a:hover {
          background: rgba(255,255,255,0.8);
        }

        h2 {
          text-align: center;
          margin-bottom: 15px;
          color: #6a5037;
        }

        form {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 12px;
          background: rgba(255, 255, 255, 0.4);
          backdrop-filter: blur(8px);
          padding: 15px;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
		
		form select,
        form input[type="text"],
        form input[type="number"] {
            max-width: 160px; /* ограничиваем ширину */
            width: 100%; /* чтобы на мобилке всё тянулось на всю ширину */
        }

        .form-block {
          display: flex;
          flex-direction: column;
        }
		
		.form-block.checkbox-group {
          flex-direction: row;
          align-items: center;
          gap: 10px;
        }

        .form-block.checkbox-group label {
          display: flex;
          align-items: center;
          gap: 5px;
          margin: 0;
        }

        label {
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 4px;
          color: #5a4633;
        }

        select, input[type="text"], input[type="number"] {
          padding: 6px 10px;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-size: 14px;
          background: rgba(255,255,255,0.85);
        }

        input[type="checkbox"] {
          transform: scale(1.1);
        }

        .btn {
          grid-column: 1 / -1;
          padding: 10px;
          background: #f4a261;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 15px;
          cursor: pointer;
          transition: background 0.3s ease;
        }

        .btn:hover {
          background: #e76f51;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="{{ url_for('admin_filter') }}">Туры</a>
        <a href="{{ url_for('admin_hotels') }}">Отели</a>
        <a href="{{ url_for('admin_places') }}">Места</a>
        <a href="{{ url_for('admin_news') }}">Новости</a>
		<a href="{{ url_for('admin_banners') }}">Баннеры</a>
        <a href="{{ url_for('admin_logout') }}">Выход</a>
    </div>

    <h2>Фильтр Туров Kazunion</h2>
	 	  <!-- Одна форма — Сохранить и запустить парсинг -->
<div style="display: flex; gap: 40px; align-items: stretch;">
  <!-- Левая часть: фильтр -->
  <div style="flex: 1;">
    <form method="post">
        <div class="form-block">
            <label>Город отправления:</label>
            <select name="city_code" required>
            <option value="68" {% if config.city_code == "68" %}selected{% endif %}>Актау</option>
            <option value="95" {% if config.city_code == "95" %}selected{% endif %}>Актобе</option>
            <option value="57" {% if config.city_code == "57" %}selected{% endif %}>Алматы</option>
            <option value="7" {% if config.city_code == "7" %}selected{% endif %}>Астана</option>
            <option value="8" {% if config.city_code == "8" %}selected{% endif %}>Атырау</option>
            <option value="82" {% if config.city_code == "82" %}selected{% endif %}>Караганда</option>
            <option value="121" {% if config.city_code == "121" %}selected{% endif %}>Костанай</option>
            <option value="196" {% if config.city_code == "196" %}selected{% endif %}>Туркестан</option>
            <option value="5" {% if config.city_code == "5" %}selected{% endif %}>Уральск</option>
            <option value="90" {% if config.city_code == "90" %}selected{% endif %}>Усть-Каменогорск</option>
            <option value="94" {% if config.city_code == "94" %}selected{% endif %}>Шымкент</option>
            <option value="207" {% if config.city_code == "207" %}selected{% endif %}>Екатеринбург</option>
            <option value="2" {% if config.city_code == "2" %}selected{% endif %}>Москва</option>
            <option value="613" {% if config.city_code == "613" %}selected{% endif %}>Санкт-Петербург</option>
            <option value="86" {% if config.city_code == "86" %}selected{% endif %}>Бишкек</option>
            <option value="839" {% if config.city_code == "839" %}selected{% endif %}>Ташкент</option>
            <option value="573" {% if config.city_code == "573" %}selected{% endif %}>Тбилиси</option>
            <option value="849" {% if config.city_code == "849" %}selected{% endif %}>Баку</option>
            </select>
        </div>

        <div class="form-block">
            <label>Страна:</label>
            <select name="country_code" required>
            <option value="48" {% if config.country_code == "48" %}selected{% endif %}>Азербайджан</option>
            <option value="22" {% if config.country_code == "22" %}selected{% endif %}>Вьетнам</option>
            <option value="43" {% if config.country_code == "43" %}selected{% endif %}>Грузия</option>
            <option value="14" {% if config.country_code == "14" %}selected{% endif %}>Индонезия</option>
            <option value="95" {% if config.country_code == "95" %}selected{% endif %}>Катар</option>
            <option value="13" {% if config.country_code == "13" %}selected{% endif %}>Малайзия</option>
            <option value="33" {% if config.country_code == "33" %}selected{% endif %}>Мальдивы</option>
            <option value="11" {% if config.country_code == "11" %}selected{% endif %}>ОАЭ</option>
            <option value="42" {% if config.country_code == "42" %}selected{% endif %}>Сингапур</option>
            <option value="73" {% if config.country_code == "73" %}selected{% endif %}>Словения</option>
            <option value="12" {% if config.country_code == "12" %}selected{% endif %}>Таиланд</option>
            <option value="6" {% if config.country_code == "6" %}selected{% endif %}>Турция</option>
            <option value="69" {% if config.country_code == "69" %}selected{% endif %}>Черногория</option>
            <option value="31" {% if config.country_code == "31" %}selected{% endif %}>Чехия</option>
            <option value="20" {% if config.country_code == "20" %}selected{% endif %}>Шри-Ланка</option>
            <option value="64" {% if config.country_code == "64" %}selected{% endif %}>Южная Корея</option>
            </select>
        </div>

        <div class="form-block">
            <label>Дата вылета:</label>
            <input type="text" name="departure_date"
      			   placeholder="ДД.ММ.ГГГГ" 
				   pattern="\d{2}\.\d{2}\.\d{4}" 
				   required>
        </div>
		
		<div class="form-block">				
            <label>Дата окончания:</label>
            <input type="text" name="departure_end"
                   placeholder="ДД.ММ.ГГГГ"
                   pattern="\d{2}\.\d{2}\.\d{4}"
                   value="{{ config.departure_end if config.departure_end else '' }}"
                   required>
        </div>

        <div class="form-block">
            <label>Ночей:</label>
            <input type="number" name="nights" min="1" max="21" value="{{ config.nights[0] if config.nights else '' }}" required>
        </div>

        <div class="form-block checkbox-group">
            <label>Питание:</label><br>
            <label><input type="checkbox" name="meal" value="AL" {% if "AL" in config.get("meal", []) %}checked{% endif %}> AL</label>
            <label><input type="checkbox" name="meal" value="BB" {% if "BB" in config.get("meal", []) %}checked{% endif %}> BB</label>
        </div>
		
		<div class="form-block">
            <label>Количество взрослых:</label>
            <select name="ADULT">
                {% for i in range(1, 14) %}
                    <option value="{{ i }}" {% if config.ADULT == i|string %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>
		
		<div class="form-block checkbox-group">
            <label>Звёздность:</label><br>
            <label><input type="checkbox" name="STARS" value="10003" {% if "10003" in config.get("STARS", []) %}checked{% endif %}> 3*</label>
            <label><input type="checkbox" name="STARS" value="10004" {% if "10004" in config.get("STARS", []) %}checked{% endif %}> 4*</label>
            <label><input type="checkbox" name="STARS" value="10001" {% if "10001" in config.get("STARS", []) %}checked{% endif %}> 5*</label>
        </div>
		
        <div class="form-block">
            <label>Валюта:</label>
            <select name="currency">
                <option value="KZT" {% if config.currency == "KZT" %}selected{% endif %}>KZT</option>
                <option value="USD" {% if config.currency == "USD" %}selected{% endif %}>USD</option>
            </select>
        </div>

        <div class="form-block">
            <label>Лимит туров:</label>
            <input type="number" name="limit" min="1" max="50" value="{{ config.limit or 10 }}">
        </div>

         <button type="submit" name="start_parser" class="btn">Запустить парсинг</button>
    </form>
</div>
	
  <!-- Правая часть: лог -->
  <div style="width: 500px;">
    <h3>Логи выполнения:</h3>
    <div id="log-box" style="
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
      padding: 5px;
      height: 350px;
      overflow-y: auto;
      border-radius: 10px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    ">
    </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
          <div class="log-message log-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endwith %}
    </div>
  </div>
</div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- Таблица туров -->
    <table>
        <thead>
            <tr>
                <th>Дата вылета</th>
                <th>Город</th>
                <th>Страна</th>
                <th>Отель</th>
                <th>Ночей</th>
                <th>Питание</th>
                <th>Мест</th>
                <th>Цена</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for tour in tours %}
            <tr>
                <td>{{ tour.departure_date }}</td>
                <td>{{ tour.city }}</td>
                <td>{{ tour.country }}</td>
                <td>{{ tour.hotel }}</td>
                <td>{{ tour.nights }}</td>
                <td>{{ tour.meal }}</td>
                <td>{{ tour.seats }}</td>
                <td>{{ tour.price }} {{ tour.currency or 'KZT' }}</td>
                <td>
                    <a href="{{ url_for('edit_filter_tour', index=loop.index0) }}">✏️</a>
                    <a href="{{ url_for('delete_filter_tour', index=loop.index0) }}">❌</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
<!-- Автообновление логов -->
<script>
  function updateLog() {
    fetch('/admin/log_text')
      .then(response => response.text())
      .then(data => {
        const logBox = document.getElementById('log-box');
        logBox.textContent = data;
        logBox.scrollTop = logBox.scrollHeight;
      });
  }

  updateLog();
  setInterval(updateLog, 5000);
</script>
</body>
</html>
